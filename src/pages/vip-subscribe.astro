---
// src/pages/vip-subscribe.astro
import Footer from '../components/Footer.astro';
import '../styles/global.css';
import ManettaBagHeaderOther from '../components/ManettaBag-Header-other.astro';
import GTMHeader from '../components/GTM-Header.astro';
import GTMBody from '../components/GTM-Body.astro';

const PAGE_TITLE = "Secure Checkout - Manetta Bag";
const BRAND_HEX = "#D46A22";
---

<!DOCTYPE html>
<html lang="en">
<head>
    <GTMHeader />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{PAGE_TITLE}</title>
    <link rel="icon" type="image/svg+xml" href="/manettabag-web-icon.svg" />
    <link rel="stylesheet" href="/tailwind.css" />
    <style define:vars={{ brandColor: BRAND_HEX }}>
      ::selection {
        background-color: var(--brandColor);
        color: white;
      }
      /* 按钮流光动画 */
      @keyframes shine-sweep {
        0% { transform: translateX(-100%) skewX(-15deg); }
        100% { transform: translateX(200%) skewX(-15deg); }
      }
      .group:hover .animate-shine {
        animation: shine-sweep 1s ease-in-out forwards;
      }
    </style>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6D5EX8ZZ35"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-6D5EX8ZZ35');
    </script>
    <!-- Meta Pixel Code -->
<script>
  !(function (f, b, e, v, n, t, s) {
    if (f.fbq) return;
    n = f.fbq = function () {
      n.callMethod
        ? n.callMethod.apply(n, arguments)
        : n.queue.push(arguments);
    };
    if (!f._fbq) f._fbq = n;
    n.push = n;
    n.loaded = !0;
    n.version = "2.0";
    n.queue = [];
    t = b.createElement(e);
    t.async = !0;
    t.src = v;
    s = b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t, s);
  })(
    window,
    document,
    "script",
    "https://connect.facebook.net/en_US/fbevents.js"
  );

  fbq("init", "2248339528989623");

  // 页面浏览
  fbq("track", "PageView");

  // ===============================
  // 发起结账（InitiateCheckout）
  // 只触发一次，防止刷新重复统计
  // ===============================
  if (!sessionStorage.getItem("meta_initiate_checkout_fired")) {
    fbq("track", "InitiateCheckout");
    sessionStorage.setItem("meta_initiate_checkout_fired", "1");
  }
</script>

<noscript>
  <img
    height="1"
    width="1"
    style="display:none"
    src="https://www.facebook.com/tr?id=2248339528989623&ev=PageView&noscript=1"
  />
</noscript>
<!-- End Meta Pixel Code -->

    </head>

<body class="min-h-screen flex flex-col bg-[#050505] text-white font-sans antialiased">
    <GTMBody />
    <ManettaBagHeaderOther />

    <main class="flex-1 w-full px-4 pt-32 pb-20 relative flex items-center justify-center overflow-hidden">
        
        <div class="absolute top-[-10%] left-1/2 -translate-x-1/2 w-[800px] h-[500px] bg-white opacity-[0.03] blur-[150px] pointer-events-none"></div>

        <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-[var(--brandColor)] opacity-[0.1] blur-[180px] rounded-full pointer-events-none"></div>

        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIj48ZmlsdGVyIGlkPSJhIj48ZmVUdXJYdWxlbmNlIGJhc2VGcmVxdWVuY3k9Ii44IiBudW1PY3RhdmVzPSI0IiByZXN1bHQ9Im5vaXNlIi8+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlXz0iMCIvPjxmZUNvbXBvbmVudFRyYW5zZmVyPjxmZUZ1bmHSPVR5cGU9ImxpbmVhciIgc2xvcGU9Ii4xIi8+PC9mZUNvbXBvbmVudFRyYW5zZmVyPjxmZUJsZW5kIG1vZGU9Im11bHRpcGx5IiBpbjI9IlNvdXJjZUdyYXBoaWMiLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWx0ZXI9InVybCgjYSkiIGZpbGw9Im5vbmUiLz48L3N2Zz4=')] opacity-20 pointer-events-none mix-blend-overlay"></div>


        <div class="w-full max-w-[480px] mx-auto relative z-10">
            
            <form id="payment-form" class="bg-[#141414] border border-white/10 rounded-2xl p-6 sm:p-8 shadow-2xl relative overflow-hidden ring-1 ring-white/5">

                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[var(--brandColor)] to-[#141414]"></div>

                <div class="flex justify-between items-end border-b border-white/10 pb-6 mb-8">
                    <div>
                        <h1 class="font-display font-bold text-2xl text-white tracking-tight">VIP Access</h1>
                        <p class="text-sm text-gray-400 mt-1 font-light">Secure your early bird discount</p>
                    </div>
                    <div class="text-right">
                        <span class="block text-3xl font-bold text-[var(--brandColor)] leading-none tracking-tight">$1.00</span>
                        <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">USD Total</span>
                    </div>
                </div>

                <div class="space-y-6 mb-8">
                    <div class="flex flex-col gap-2 group">
                        <label for="customer-email" class="text-xs font-bold text-gray-400 uppercase tracking-widest group-focus-within:text-[var(--brandColor)] transition-colors">Subscribe Email</label>
                        <input
                          type="email"
                          id="customer-email"
                          required
                          placeholder="name@example.com"
                          class="w-full h-[50px] bg-[#0A0A0A] border border-[#333] rounded-lg px-4 text-white placeholder-gray-600 focus:outline-none focus:border-[var(--brandColor)] focus:ring-1 focus:ring-[var(--brandColor)] transition-all text-base"
                        >
                    </div>
                    <div class="flex flex-col gap-2 group">
                        <label for="customer-name" class="text-xs font-bold text-gray-400 uppercase tracking-widest group-focus-within:text-[var(--brandColor)] transition-colors">Full Name</label>
                        <input
                          type="text"
                          id="customer-name"
                          required
                          placeholder="Name on card"
                          class="w-full h-[50px] bg-[#0A0A0A] border border-[#333] rounded-lg px-4 text-white placeholder-gray-600 focus:outline-none focus:border-[var(--brandColor)] focus:ring-1 focus:ring-[var(--brandColor)] transition-all text-base"
                        >
                    </div>
                </div>

                <div class="mb-8">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Payment Details</h3>
                        </div>
                    
                    <div id="payment-element-container" class="min-h-[50px]">
                        <div class="animate-pulse h-[50px] bg-[#0A0A0A] border border-[#333] rounded-lg w-full"></div>
                    </div>
                    
                    <div id="payment-message" role="alert" class="hidden text-[var(--brandColor)] text-sm mt-3 text-center font-bold bg-[var(--brandColor)]/10 py-2 rounded border border-[var(--brandColor)]/20"></div>
                </div>

                <div class="text-xs text-gray-500 text-center mb-6 leading-relaxed px-2">
                    By paying, you agree to the <a href="/terms" class="text-gray-300 hover:text-white underline transition-colors">Terms</a> and <a href="/privacy" class="text-gray-300 hover:text-white underline transition-colors">Privacy Policy</a>.
                </div>

                <button id="submit-payment-btn" type="submit" class="group relative w-full h-14 bg-[#D46A22] hover:bg-[#b5581b] text-white font-bold rounded-xl shadow-[0_5px_20px_-5px_rgba(212,106,34,0.4)] hover:shadow-[0_10px_30px_-5px_rgba(212,106,34,0.6)] transition-all duration-300 transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 overflow-hidden">
                    
                    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full animate-shine pointer-events-none"></div>

                    <span id="button-text" class="text-lg tracking-widest font-display uppercase relative z-10 text-shadow-sm">Pay Securely</span>
                    
                    <svg class="w-5 h-5 text-white/90 relative z-10 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    
                    <span id="spinner" class="hidden relative z-10">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </span>
                </button>
                
                <div class="text-center mt-6 flex flex-col items-center gap-2 opacity-40 hover:opacity-70 transition-opacity">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                    <p class="text-[10px] text-white tracking-widest uppercase leading-tight font-medium">
                        Securely processed by Stripe. SSL encryption.
                    </p>
                </div>

            </form>
        </div>
    </main>

    <Footer />

    <script src="https://js.stripe.com/v3/"></script>
    <script define:vars={{ brandColor: BRAND_HEX }}>
    // @ts-nocheck
    document.addEventListener('DOMContentLoaded', function () {
      // ⚠️ 记得确保这里是你的 Live Key (如果已上线) 或 Test Key (如果还在测试)
      var stripe = Stripe('pk_live_51QkM6jJrrVdgshd2SopK4pf9x8DeLu8ocJWJNtbGNveVkQcnRQcAM3TQbTohIchI0HqCT6lh474GILSFKfLxUtrj00XeN0aHoY');

      var elements;
      var form = document.getElementById('payment-form');
      var messageContainer = document.getElementById('payment-message');
      var submitButton = document.getElementById('submit-payment-btn');
      var buttonText = document.getElementById('button-text');
      var spinner = document.getElementById('spinner');
      var customerEmail = document.getElementById('customer-email');
      var customerName = document.getElementById('customer-name');
      
      var backendApiUrl = '/api/create-payment-intent';
      var vipKlaviyoApiUrl = '/api/klaviyo-vip-subscribe';

      // 1. Prefill
      try {
        var finalEmail = '';
        var params = new URLSearchParams(window.location.search);
        if (params.get('email')) {
            finalEmail = params.get('email').trim();
        } else if (localStorage.getItem('manetta_email')) {
            finalEmail = localStorage.getItem('manetta_email').trim();
        }

        if (finalEmail && customerEmail) {
          customerEmail.value = finalEmail;
          customerEmail.readOnly = true;
          // 锁定样式：稍微变暗
          customerEmail.classList.add('opacity-60', 'cursor-not-allowed');
        }
      } catch (err) { console.warn('Email prefill error', err); }

      // 2. Initialize
      initialize();

      async function initialize() {
        try {
          var response = await fetch(backendApiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          var json = await response.json();

          if (!json.clientSecret) {
             showMessage('System Error: Could not initiate payment.');
             return;
          }

          // ⭐⭐ Stripe 配置：完美同步 HTML 输入框样式 ⭐⭐
          const appearance = {
            theme: 'night', 
            variables: {
              colorPrimary: brandColor,
              colorBackground: '#0A0A0A', 
              colorText: '#ffffff',
              colorDanger: brandColor,
              fontFamily: 'Inter, system-ui, sans-serif',
              borderRadius: '8px', 
              spacingUnit: '4px',
              placeholderColor: '#525252' 
            },
            rules: {
                '.Input': {
                    border: '1px solid #333333', 
                    backgroundColor: '#0A0A0A',
                    color: '#ffffff',
                    paddingTop: '12px', 
                    paddingBottom: '12px',
                    fontSize: '16px',
                },
                '.Input:focus': {
                    border: `1px solid ${brandColor}`,
                    boxShadow: 'none'
                },
                '.Label': {
                    color: '#9ca3af', 
                    fontSize: '12px', 
                    fontWeight: '700', 
                    textTransform: 'uppercase',
                    letterSpacing: '0.1em', 
                    marginBottom: '8px'
                }
            }
          };

          elements = stripe.elements({ 
              clientSecret: json.clientSecret, 
              appearance: appearance 
          });

          // ✅ 修复拼写错误: walettes -> wallets
          var paymentElement = elements.create('payment', {
            wallets: { link: 'never' },
            fields: { billingDetails: { name: 'never', email: 'never' } }
          });

          paymentElement.mount('#payment-element-container');

        } catch (error) {
          console.error(error);
          showMessage('Failed to load payment system.');
        }
      }

      // 3. Submit
      if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            setLoading(true);

            var emailVal = customerEmail.value.trim();
            var nameVal = customerName.value.trim();

            if (!emailVal) {
                showMessage('Please enter your email.');
                setLoading(false);
                return;
            }

            const { error, paymentIntent } = await stripe.confirmPayment({
                elements: elements,
                confirmParams: {
                    payment_method_data: {
                        billing_details: { name: nameVal, email: emailVal }
                    }
                },
                redirect: 'if_required'
            });

            if (error) {
                showMessage(error.message);
                setLoading(false);
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                // ✅ 支付成功！
                
                // 1. 先触发 Klaviyo 订阅（后端）
                await subscribeToKlaviyo(emailVal, nameVal);

                // =================================================================
                // ✅ TRACKING: 触发 Facebook Pixel 'Subscribe' 事件 (含价值 1.00)
                // =================================================================
                if (typeof fbq === 'function') {
                    fbq('track', 'Subscribe', {
                        value: 1.00,       // 确认为 1.00 USD
                        currency: 'USD',   // 货币单位
                        content_name: 'VIP Access Reservation', // 添加内容名称以便区分
                    });
                    console.log("Pixel 'Subscribe' event fired for $1.00");
                }

                // =================================================================
                // ✅ TRACKING: 新增 GA4 'purchase' 事件 (含价值 1.00 和交易 ID)
                // =================================================================
                if (typeof gtag === 'function') {
                    gtag('event', 'purchase', {
                        transaction_id: paymentIntent.id, // 使用 Stripe 的交易 ID 进行去重
                        currency: 'USD',
                        value: 1.00,
                        items: [
                            {
                                item_id: 'vip-access-reservation',
                                item_name: 'VIP Access Reservation',
                                price: 1.00,
                                quantity: 1
                            }
                        ]
                    });
                    console.log("GA4 'purchase' event fired for $1.00, ID:", paymentIntent.id);
                }
                // =================================================================

                var thankyouUrl = 'https://manettabag.com/thankyou' 
                    + '?email=' + encodeURIComponent(emailVal)
                    + '&name=' + encodeURIComponent(nameVal);
                
                // ✅ 关键：添加短暂延时，确保 Pixel/GA4 请求发送成功后再跳转
                setTimeout(function() {
                    window.location.href = thankyouUrl;
                }, 500); // 500毫秒延迟通常足够

            } else {
                showMessage('Payment failed. Please try again.');
                setLoading(false);
            }
        });
      }

      async function subscribeToKlaviyo(email, name) {
        try {
            await fetch(vipKlaviyoApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, name })
            });
        } catch (e) { console.warn('Klaviyo error', e); }
      }

      function showMessage(messageText) {
        if (messageContainer) {
            messageContainer.textContent = messageText;
            messageContainer.classList.remove('hidden');
        }
      }

      function setLoading(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            spinner.classList.remove('hidden');
        } else {
            submitButton.disabled = false;
            buttonText.classList.remove('hidden');
            spinner.classList.add('hidden');
        }
      }
    });
    </script>

</body>
</html>