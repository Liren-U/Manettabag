---
// src/pages/vip-subscribe.astro
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

const PAGE_TITLE = "Single-Page Checkout - Manetta Bag";
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{PAGE_TITLE}</title>
</head>
<body>

    <Header />

    <main class="checkout-page-main">
        <div class="checkout-container">
            <h1>Secure VIP Subscription Checkout</h1>

            <form id="payment-form" class="unified-checkout-form">

                <div class="price-summary-box">
                    <h2>Total Amount Due</h2>
                    <p class="price-tag">$ 5.00 USD</p>
                    <p class="plan-info">Manetta VIP Subscription (Annual)</p>
                </div>

                <h3 class="section-title">1. Your Contact Details</h3>
                <div class="custom-form-fields">
                    <div class="input-group">
                        <label for="customer-name">Full Name</label>
                        <input type="text" id="customer-name" required placeholder="Enter your full name">
                    </div>
                    <div class="input-group">
                        <label for="customer-email">Email Address (for Receipt & Account)</label>
                        <input type="email" id="customer-email" required placeholder="Enter your email address">
                    </div>
                </div>

                <h3 class="section-title">2. Payment Information</h3>
                <div id="payment-element-container" class="payment-card-box">
                    <p>Loading card details...</p>
                </div>

                <div id="payment-message" role="alert"></div>

                <div class="terms-and-conditions">
                    <p>
                        By paying, you agree to the
                        <a href="/terms" target="_blank" rel="noopener noreferrer">Terms of Service</a>
                        and
                        <a href="/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.
                    </p>
                </div>

                <button id="submit-payment-btn">
                    <span id="button-text">Pay $5.00 Now</span>
                </button>

                <p class="security-info">Securely processed by Stripe. SSL encryption.</p>
            </form>
        </div>
    </main>

    <Footer />

    <script src="https://js.stripe.com/v3/"></script>
    <script>
    // @ts-nocheck  告诉 VSCode/TS 对这个脚本不要做类型检查

    document.addEventListener('DOMContentLoaded', function () {
      // 建议开发时先用 pk_test，正式再换回 pk_live
      var stripe = Stripe('pk_live_51QkM6jJrrVdgshd2SopK4pf9x8DeLu8ocJWJNtbGNveVkQcnRQcAM3TQbTohIchI0HqCT6lh474GILSFKfLxUtrj00XeN0aHoY');

      var elements;
      var form = document.getElementById('payment-form');
      var paymentElementContainer = document.getElementById('payment-element-container');
      var submitButton = document.getElementById('submit-payment-btn');
      var messageContainer = document.getElementById('payment-message');

      var customerEmail = document.getElementById('customer-email');
      var customerName = document.getElementById('customer-name');

      var backendApiUrl = '/api/create-payment-intent';

      // 防止 Stripe SDK 没加载成功
      if (typeof Stripe === 'undefined') {
        if (messageContainer) {
          messageContainer.textContent = 'Error: Stripe SDK failed to load.';
        }
        return;
      }

      initialize();

      async function initialize() {
        try {
          var response = await fetch(backendApiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            if (messageContainer) {
              messageContainer.textContent = 'Server error fetching client secret: Status ' + response.status;
            }
            return;
          }

          var json = await response.json();
          var clientSecret = json.clientSecret;
          var apiError = json.error;

          if (apiError || !clientSecret) {
            if (messageContainer) {
              messageContainer.textContent = apiError || 'Could not start payment process. Check backend config or logs.';
            }
            return;
          }

          // 初始化 Stripe Elements
          elements = stripe.elements({ clientSecret: clientSecret });

          var paymentElement = elements.create('payment', {
            fields: {
              billingDetails: {
                name: 'never',
                email: 'never'
              }
            }
          });
          paymentElement.mount(paymentElementContainer);
        } catch (error) {
          console.error('Error fetching client secret:', error);
          if (messageContainer) {
            messageContainer.textContent = 'Payment initialization failed. Check network or configuration.';
          }
        }
      }

      if (form) {
        form.addEventListener('submit', handleSubmit);
      }

      async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);

        var result = await stripe.confirmPayment({
          elements: elements,
          confirmParams: {
            return_url: window.location.origin + '/payment-success',
            payment_method_data: {
              billing_details: {
                name: customerName ? customerName.value : '',
                email: customerEmail ? customerEmail.value : ''
              }
            }
          }
        });

        if (result.error) {
          if (messageContainer) {
            if (result.error.type === 'card_error' || result.error.type === 'validation_error') {
              messageContainer.textContent = result.error.message;
            } else {
              messageContainer.textContent = 'An unknown error occurred. Please try again.';
            }
          }
        }

        setLoading(false);
      }

      function setLoading(isLoading) {
        var buttonText = document.getElementById('button-text');
        if (!submitButton || !buttonText) return;

        if (isLoading) {
          submitButton.disabled = true;
          buttonText.textContent = 'Processing...';
        } else {
          submitButton.disabled = false;
          buttonText.textContent = 'Pay $5.00 Now';
        }
      }
    });
    </script>

</body>
</html>

<style>
/* ------------------------------------- */
/* BASE STYLES */
/* ------------------------------------- */
    .checkout-page-main {
        padding: 40px 20px;
        min-height: 85vh;
        background-color: #f0f2f5; /* Light background for contrast */
    }

    .checkout-container {
        max-width: 500px;
        margin: 0 auto;
    }

    h1 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 2em;
        color: #333;
    }

    .unified-checkout-form {
        padding: 30px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

/* ------------------------------------- */
/* PRICE SUMMARY BOX */
/* ------------------------------------- */
    .price-summary-box {
        text-align: center;
        padding: 15px 0 25px;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }

    .price-summary-box h2 {
        font-size: 1.1em;
        font-weight: 500;
        color: #666;
        margin-bottom: 5px;
    }

    .price-tag {
        font-size: 2.5em;
        font-weight: 700;
        color: #1a73e8; /* Prominent color for the price */
        margin: 0;
    }

    .plan-info {
        font-size: 0.9em;
        color: #999;
        margin-top: 5px;
    }

/* ------------------------------------- */
/* FORM SECTIONS & INPUTS */
/* ------------------------------------- */
    .section-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #f0f0f0;
    }

    .custom-form-fields .input-group {
        margin-bottom: 15px;
    }

    .custom-form-fields label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 0.9em;
        color: #555;
    }

    .custom-form-fields input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1em;
    }

    .payment-card-box {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        min-height: 40px; /* Placeholder minimum height for loading */
    }

/* ------------------------------------- */
/* BUTTONS & MESSAGES */
/* ------------------------------------- */
    .terms-and-conditions {
        margin: 25px 0 15px;
        font-size: 0.9em;
    }

    #submit-payment-btn {
        width: 100%;
        padding: 14px;
        background-color: #1a73e8; /* Google Blue */
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background-color 0.3s;
        font-weight: 600;
    }

    #submit-payment-btn:disabled {
        background-color: #99bfea;
        cursor: not-allowed;
    }

    #payment-message {
        color: #d93025; /* Error red */
        font-weight: bold;
        margin-top: 15px;
        text-align: center;
    }

    .security-info {
        text-align: center;
        margin-top: 15px;
        font-size: 0.8em;
        color: #888;
    }
</style>
