---
// src/pages/vip-subscribe.astro
// Assuming Header and Footer components are set up
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const PAGE_TITLE = "VIP Subscription Checkout - Manetta Bag";
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{PAGE_TITLE}</title>
    <link rel="stylesheet" href="/global.css" />

    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

    <Header />

    <main class="checkout-page-main">
        <div class="checkout-container">
            <h1>VIP Subscription Checkout</h1>

            <section class="plan-summary">
                <h2>Your Subscription</h2>
                <p>Manetta VIP Subscription: <strong id="plan-name">Annual Premium</strong></p>
                <p>Price: <strong id="plan-price">$ 5.00 USD / Year</strong></p>
                <a href="/offer">Change Offer</a>
            </section>

            <section class="payment-form-section">
                <h2>Billing and Payment</h2>

                <form id="payment-form">
                    <div class="custom-form-fields">
                        <div class="input-group">
                            <label for="customer-email">Email Address</label>
                            <input type="email" id="customer-email" required placeholder="Enter your email address">
                        </div>
                        <div class="input-group">
                            <label for="customer-name">Full Name</label>
                            <input type="text" id="customer-name" required placeholder="Enter your full name">
                        </div>
                    </div>

                    <h3 class="card-details-title">Card Details</h3>
                    
                    <div id="payment-element-container">
                        <p>Loading payment form...</p>
                    </div>

                    <div id="payment-message" role="alert"></div>

                    <div class="terms-and-conditions">
                        <input type="checkbox" id="agree-terms" required checked>
                        <label for="agree-terms">I have read and agree to the <a href="/terms" target="_blank" rel="noopener noreferrer">Terms of Service</a> and <a href="/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.</label>
                    </div>

                    <button id="submit-payment-btn">
                        <span id="button-text">Confirm Payment $5.00</span>
                    </button>

                    <p class="security-info">Your transaction is secured with SSL encryption.</p>
                </form>
            </section>
        </div>
    </main>

    <Footer />

    <script is:inline>
        // Use your provided Public Key (Test Key)
        const stripe = Stripe('pk_test_51QkM6jJrrVdgshd2MDfLWbtSQ9spW0T04calhNKj2x5Sg264hHIHESnwzOGziGpDl77AVWomFyKxkrW1EYbbbCEs00Fd6DRAFq');

        let elements;
        const form = document.getElementById('payment-form');
        const paymentElementContainer = document.getElementById('payment-element-container');
        const submitButton = document.getElementById('submit-payment-btn');
        const messageContainer = document.getElementById('payment-message');
        const termsCheckbox = document.getElementById('agree-terms');

        // New form field references
        const customerEmail = document.getElementById('customer-email');
        const customerName = document.getElementById('customer-name');

        const backendApiUrl = '/api/create-payment-intent';

        // ----------------------------------------------------
        // 1. Initialize Payment Flow
        // ----------------------------------------------------
        initialize();

        async function initialize() {
            try {
                // Call backend API to get clientSecret
                const response = await fetch(backendApiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                });

                const { clientSecret, error: apiError } = await response.json();

                if (apiError || !clientSecret) {
                    messageContainer.textContent = apiError || "Could not start payment process. Please check backend config.";
                    return;
                }

                // Initialize Elements object
                elements = stripe.elements({ clientSecret });

                // ðŸš€ KEY CHANGE: Configure Payment Element to NOT collect name/email 
                // We collect them in the custom HTML form instead.
                const paymentElement = elements.create("payment", {
                    fields: {
                        billingDetails: {
                            name: 'never', // We collect name manually
                            email: 'never', // We collect email manually
                        }
                    }
                });
                paymentElement.mount(paymentElementContainer);

                // Listener for terms checkbox
                const updateButtonState = () => {
                    submitButton.disabled = !termsCheckbox.checked;
                };
                termsCheckbox.addEventListener('change', updateButtonState);
                updateButtonState();

            } catch (error) {
                console.error("Error fetching client secret:", error);
                messageContainer.textContent = "Payment initialization failed. Check network or configuration.";
            }
        }

        // ----------------------------------------------------
        // 2. Form Submission Handling
        // ----------------------------------------------------
        form.addEventListener("submit", handleSubmit);

        async function handleSubmit(e) {
            e.preventDefault();
            setLoading(true);

            if (!termsCheckbox.checked) {
                messageContainer.textContent = "Please agree to the terms of service.";
                setLoading(false);
                return;
            }

            // Call Stripe API to confirm payment
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: `${window.location.origin}/payment-success`,
                    // ðŸš€ KEY CHANGE: Pass collected Name and Email from our custom fields
                    payment_method_data: {
                        billing_details: {
                            name: customerName.value,
                            email: customerEmail.value,
                        },
                    },
                },
            });

            // Handle errors
            if (error) {
                if (error.type === "card_error" || error.type === "validation_error") {
                    messageContainer.textContent = error.message;
                } else {
                    messageContainer.textContent = "An unknown error occurred. Please try again.";
                }
            }

            setLoading(false);
        }

        // ----------------------------------------------------
        // 3. Helper Functions
        // ----------------------------------------------------
        function setLoading(isLoading) {
            const buttonText = document.getElementById("button-text");
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.textContent = "Processing...";
            } else {
                submitButton.disabled = !termsCheckbox.checked;
                buttonText.textContent = "Confirm Payment $5.00";
            }
        }
    </script>
    
</body>
</html>

<style>
/* ------------------------------------- */
/* BASE & FORM STYLES */
/* ------------------------------------- */
    .checkout-page-main {
        padding: 60px 20px;
        min-height: 80vh;
        background-color: #f9f9f9;
    }

    .checkout-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 30px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .plan-summary, .payment-form-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 6px;
    }

    .plan-summary a {
        display: block;
        margin-top: 10px;
        color: #007bff;
        text-decoration: none;
    }
    
    .card-details-title {
        font-size: 1.2em;
        margin-top: 25px;
        margin-bottom: 10px;
    }

/* ------------------------------------- */
/* CUSTOM INPUT STYLES */
/* ------------------------------------- */
    .custom-form-fields .input-group {
        margin-bottom: 15px;
    }
    
    .custom-form-fields label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 0.9em;
        color: #555;
    }
    
    .custom-form-fields input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

/* ------------------------------------- */
/* BUTTONS & MESSAGES */
/* ------------------------------------- */
    #submit-payment-btn {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 20px;
    }

    #submit-payment-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #payment-message {
        color: #cc0000;
        font-weight: bold;
        margin-top: 10px;
        text-align: center;
    }

    .security-info {
        text-align: center;
        margin-top: 15px;
        font-size: 0.85em;
        color: #666;
    }
</style>