---
// src/pages/vip-subscribe.astro
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const PAGE_TITLE = "VIP è®¢é˜…ç»“è´¦ - Manetta Bag";
---

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{PAGE_TITLE}</title>
    <link rel="stylesheet" href="/global.css" />

    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

    <Header />

    <main class="checkout-page-main">
        <div class="checkout-container">
            <h1>VIP è®¢é˜…ç»“è´¦</h1>

            <section class="plan-summary">
                <h2>æ‚¨çš„è®¢é˜…æ–¹æ¡ˆ</h2>
                <p>Manetta VIP è®¢é˜…ï¼š<strong id="plan-name">å¹´åº¦å°Šäº«ç‰ˆ</strong></p>
                <p>ä»·æ ¼ï¼š<strong id="plan-price">$ 5.00 USD / å¹´</strong></p>
                <a href="/offer">è¿”å›ä¼˜æƒ é¡µä¿®æ”¹</a>
            </section>

            <section class="payment-form-section">
                <h2>é€‰æ‹©æ”¯ä»˜æ–¹å¼</h2>

                <form id="payment-form">
                    <div id="payment-element-container">
                        <p>æ­£åœ¨åŠ è½½æ”¯ä»˜ç»„ä»¶...</p>
                    </div>

                    <div id="payment-message" role="alert"></div>

                    <div class="terms-and-conditions">
                        <input type="checkbox" id="agree-terms" required checked>
                        <label for="agree-terms">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="/terms" target="_blank">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="/privacy" target="_blank">éšç§æ”¿ç­–</a>ã€‚</label>
                    </div>

                    <button id="submit-payment-btn">
                        <span id="button-text">ç¡®è®¤æ”¯ä»˜ $5.00</span>
                    </button>

                    <p class="security-info">æ‚¨çš„äº¤æ˜“å®‰å…¨å—åˆ° SSL åŠ å¯†ä¿æŠ¤ã€‚</p>
                </form>
            </section>
        </div>
    </main>

    <Footer />

    <script is:inline>
        // ğŸš¨ æ›¿æ¢ä¸ºæ‚¨çš„ Stripe Public Key (pk_live_xxxx æˆ– pk_test_xxxx)
        const stripe = Stripe('pk_test_51QkM6jJrrVdgshd2MDfLWbtSQ9spW0T04calhNKj2x5Sg264hHIHESnwzOGziGpDl77AVWomFyKxkrW1EYbbbCEs00Fd6DRAFq');

        let elements;
        const form = document.getElementById('payment-form');
        const paymentElementContainer = document.getElementById('payment-element-container');
        const submitButton = document.getElementById('submit-payment-btn');
        const messageContainer = document.getElementById('payment-message');
        const termsCheckbox = document.getElementById('agree-terms');

        // è¿™æ˜¯æ­¥éª¤ 1 ä¸­åˆ›å»ºçš„ Cloudflare Functions API è·¯ç”±
        const backendApiUrl = '/api/create-payment-intent';

        // ----------------------------------------------------
        // 1. åˆå§‹åŒ–æ”¯ä»˜æµç¨‹
        // ----------------------------------------------------
        initialize();

        async function initialize() {
            try {
                // è°ƒç”¨åç«¯ API è·å– clientSecret
                const response = await fetch(backendApiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // Body å¯ä»¥ä¸ºç©ºï¼Œå› ä¸ºé‡‘é¢å·²åœ¨åç«¯å›ºå®šä¸º 500
                });

                const { clientSecret, error: apiError } = await response.json();

                if (apiError || !clientSecret) {
                    messageContainer.textContent = apiError || "æ— æ³•å¯åŠ¨æ”¯ä»˜æµç¨‹ã€‚è¯·æ£€æŸ¥åç«¯é…ç½®ã€‚";
                    return;
                }

                // åˆå§‹åŒ– Elements å¯¹è±¡
                elements = stripe.elements({ clientSecret });

                const paymentElement = elements.create("payment");
                paymentElement.mount(paymentElementContainer);

                // ç›‘å¬æ¡æ¬¾å‹¾é€‰æ¡†å¹¶å¯ç”¨/ç¦ç”¨æŒ‰é’®
                const updateButtonState = () => {
                    submitButton.disabled = !termsCheckbox.checked;
                };
                termsCheckbox.addEventListener('change', updateButtonState);

                updateButtonState(); // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€

            } catch (error) {
                console.error("Error fetching client secret:", error);
                messageContainer.textContent = "æ”¯ä»˜åˆå§‹åŒ–å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚";
            }
        }

        // ----------------------------------------------------
        // 2. è¡¨å•æäº¤å¤„ç†
        // ----------------------------------------------------
        form.addEventListener("submit", handleSubmit);

        async function handleSubmit(e) {
            e.preventDefault();
            setLoading(true);

            if (!termsCheckbox.checked) {
                messageContainer.textContent = "è¯·å…ˆåŒæ„æœåŠ¡æ¡æ¬¾ã€‚";
                setLoading(false);
                return;
            }

            // è°ƒç”¨ Stripe API ç¡®è®¤æ”¯ä»˜
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // æ”¯ä»˜æˆåŠŸåé‡å®šå‘åˆ°æ­¤ URL
                    return_url: `${window.location.origin}/payment-success`,
                },
            });

            // åªæœ‰åœ¨å‘ç”Ÿé”™è¯¯æ—¶æ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
            if (error) {
                if (error.type === "card_error" || error.type === "validation_error") {
                    messageContainer.textContent = error.message;
                } else {
                    messageContainer.textContent = "å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚";
                }
            }
            // å¦‚æœæˆåŠŸï¼Œç”¨æˆ·å°†è¢«é‡å®šå‘åˆ° return_url

            setLoading(false);
        }

        // ----------------------------------------------------
        // 3. è¾…åŠ©å‡½æ•°
        // ----------------------------------------------------
        function setLoading(isLoading) {
            const buttonText = document.getElementById("button-text");
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.textContent = "å¤„ç†ä¸­...";
            } else {
                submitButton.disabled = !termsCheckbox.checked;
                buttonText.textContent = "ç¡®è®¤æ”¯ä»˜ $5.00";
            }
        }
    </script>
    </body>
</html>

<style>
    /* é’ˆå¯¹æ”¯ä»˜é¡µé¢çš„åŸºç¡€æ ·å¼ */
    .checkout-page-main {
        padding: 60px 20px;
        min-height: 80vh;
        background-color: #f9f9f9;
    }

    .checkout-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 30px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        text-align: center;
        margin-bottom: 30px;
    }

    .plan-summary, .payment-form-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 6px;
    }

    .plan-summary a {
        display: block;
        margin-top: 10px;
        color: #007bff;
    }

    #submit-payment-btn {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 20px;
    }

    #submit-payment-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #payment-message {
        color: red;
        font-weight: bold;
        margin-top: 10px;
    }

    .security-info {
        text-align: center;
        margin-top: 15px;
        font-size: 0.85em;
        color: #666;
    }
</style>