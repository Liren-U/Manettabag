---
/**
 * ManettaBag-Hero-Banner.astro
 * Hero banner 模块（带邮箱表单 + 分享裂变弹窗）
 * ✅ 修改：添加社交媒体图标 + Copy Link 功能
 */
---

<style is:inline>
  /* --- 响应式隐藏逻辑 --- */
  @media (max-width: 767px) {
    #reserve {
      display: none !important;
    }
  }
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* --- 弹窗样式 --- */
  .popup-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    z-index: 9999;
    animation: popupFadeIn 0.4s ease;
  }

  .popup-container {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 850px;
    background: #fff;
    color: #1a1a1a;
    display: flex;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  }

  /* 左侧图片 */
  .popup-left {
    flex: 1;
    background: #2a2a2a;
    position: relative;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .popup-left img {
    width: 100%; height: 100%; object-fit: cover;
  }
  .popup-badge {
    position: absolute;
    top: 20px; left: 20px;
    background: #c6a35d;
    color: white;
    padding: 5px 12px;
    font-size: 12px;
    font-weight: bold;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* 右侧内容 */
  .popup-right {
    flex: 1.3;
    padding: 40px 50px;
    text-align: left;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .popup-right h2 {
    font-family: 'Optima', 'Palatino', serif;
    font-size: 26px;
    margin: 0 0 10px 0;
    text-transform: uppercase;
    color: #1a1a1a;
    font-weight: bold;
  }

  .reward-intro {
    color: #555;
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 20px;
    font-weight: 500;
  }

  .step-list {
    margin: 0 0 25px 0;
    padding: 0;
    list-style: none;
  }

  .step-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    font-size: 13px;
    color: #333;
    line-height: 1.4;
  }

  .step-num {
    width: 20px; height: 20px;
    background: #1a1a1a;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    margin-right: 10px;
    margin-top: 1px;
    flex-shrink: 0;
  }

  /* ✅ 修改：按钮组样式 */
  .action-group {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr; /* 电脑端一行4个 */
    gap: 10px;
    margin-bottom: 15px;
  }

  .btn-share {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    border: 1px solid #ddd;
    text-decoration: none;
    color: #555;
    font-size: 10px;
    font-weight: bold;
    transition: 0.2s;
    border-radius: 6px;
    text-transform: uppercase;
    background: #f9f9f9;
    cursor: pointer; /* 确保 Copy Link 看起来像按钮 */
  }
  
  .btn-share:hover {
    background: #1a1a1a;
    color: #fff;
    border-color: #1a1a1a;
  }

  /* 图标样式 */
  .btn-share svg {
    width: 20px;
    height: 20px;
    margin-bottom: 6px;
    fill: currentColor; /* 图标颜色跟随文字颜色 */
  }

  .popup-footer {
    font-size: 11px; 
    color: #999; 
    border-top: 1px solid #eee;
    padding-top: 15px;
    margin-top: 5px;
  }

  .close-x {
    position: absolute;
    right: 15px; top: 10px;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    border: none; background: none;
    z-index: 10;
    line-height: 1;
  }
  .close-x:hover { color: #1a1a1a; }

  @keyframes popupFadeIn {
    from { opacity: 0; transform: scale(0.98); } 
    to { opacity: 1; transform: scale(1); }
  }

  /* 手机端适配 */
  @media (max-width: 768px) {
    .popup-container { flex-direction: column; height: auto; max-height: 90vh; width: 90%; }
    .popup-left { min-height: 150px; display: none; }
    .popup-right { padding: 30px 20px; overflow-y: auto; }
    /* 手机端变为2行2列，更大更好点 */
    .action-group { grid-template-columns: 1fr 1fr; } 
  }
</style>

<section
  id="reserve"
  class="relative w-full min-h-screen pt-32 pb-20 lg:pt-0 lg:pb-0 flex items-center overflow-hidden bg-dark-main"
>
  <div class="absolute top-[-30%] right-[-20%] w-[1000px] h-[1000px] bg-gradient-radial from-brand/20 to-transparent rounded-full blur-[150px] pointer-events-none opacity-60"></div>
  <div class="absolute bottom-[-20%] left-[-10%] w-[800px] h-[800px] bg-gradient-radial from-[#333]/30 to-transparent rounded-full blur-[120px] pointer-events-none"></div>
  <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIj48ZmlsdGVyIGlkPSJhIj48ZmVUdXJYdWxlbmNlIGJhc2VGcmVxdWVuY3k9Ii44IiBudW1PY3RhdmVzPSI0IiByZXN1bHQ9Im5vaXNlIi8+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlXz0iMCIvPjxmZUNvbXBvbmVudFRyYW5zZmVyPjxmZUZ1bmHSPVR5cGU9ImxpbmVhciIgc2xvcGU9Ii4xIi8+PC9mZUNvbXBvbmVudFRyYW5zZmVyPjxmZUJsZW5kIG1vZGU9Im11bHRpcGx5IiBpbj0iU291cmNlR3JhcGhpYyIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNhKSIgZmlsbD0ibm9uZSIvPjwvc3ZnPg==')] opacity-20 pointer-events-none"></div>

  <div class="max-w-limit mx-auto px-6 lg:px-gutter w-full grid grid-cols-1 lg:grid-cols-2 gap-16 items-center relative z-10">
    <div class="reveal active flex flex-col items-start">
      <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5 border border-white/10 mb-10 backdrop-blur-md">
        <span class="relative flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-brand"></span>
        </span>
        <span class="text-xs font-bold tracking-widest text-light-muted uppercase">Kickstarter Launching Soon</span>
      </div>

      <h1 class="font-display font-bold text-6xl lg:text-[6.5rem] leading-[0.9] tracking-tight mb-8 text-white">
        Redefine Your <br />
        <span class="text-white/40">Camera Bag</span>
      </h1>

      <p class="text-xl text-light-muted mb-12 max-w-md leading-relaxed">
        Meet <strong class="text-white">MANETTA</strong> — a 3-in-1 modular system that expands from 22L to 42L in seconds. One bag, built for every shoot.
      </p>

      <div class="w-full max-w-md lg:max-w-lg xl:max-w-xl p-[1px] rounded-2xl bg-gradient-to-br from-white/20 to-white/0">
        <div class="bg-dark-card/90 backdrop-blur-xl rounded-2xl p-8 relative overflow-hidden">
          <div class="absolute -top-20 -right-20 w-40 h-40 bg-brand/30 rounded-full blur-[60px]"></div>

          <div class="mb-8 relative">
            <div class="text-brand font-bold text-xs uppercase tracking-wider mb-2">Super Early Bird Access</div>
            <div class="text-4xl font-display font-bold text-white">Get 34% OFF</div>
          </div>

          <form id="hero-form" class="flex flex-col sm:flex-row gap-3 relative">
            <input
              id="hero-email"
              type="email"
              inputmode="email"
              autocomplete="email"
              placeholder="Your email address"
              class="w-full sm:flex-1 bg-white/5 border border-white/10 rounded-xl px-5 py-4 text-white placeholder-light-muted/50 focus:outline-none focus:border-brand/50 focus:bg-white/10 transition-all min-w-0"
              required
            />
            <button
              id="hero-submit-btn"
              type="submit"
              class="w-full sm:w-auto bg-brand hover:bg-brand/90 text-white px-6 py-4 rounded-xl font-bold transition-all duration-300 shadow-glow flex items-center justify-center whitespace-nowrap shrink-0"
            >
              Subscribe Now
            </button>
          </form>
          <br>
          <div class="text-brand font-bold text-xs uppercase tracking-wider mb-2">
            We'll notify you the moment we go live.
          </div>
        </div>
      </div>
    </div>

    <div class="reveal delay-200 relative lg:h-screen flex items-center justify-center perspective-1000 active">
      <div class="relative w-full max-w-[750px] transform-style-3d animate-float-slow">
        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-[80%] h-20 bg-brand/20 blur-[80px] rounded-full"></div>
        <img
          src="/images/Manetta-hero-banner-product.png"
          alt="Manetta Backpack"
          class="w-full h-auto object-contain drop-shadow-[0_50px_80px_rgba(0,0,0,0.5)]"
        />
      </div>
    </div>
  </div>

  <div id="sharePopup" class="popup-overlay">
    <div class="popup-container">
      <button id="popupCloseBtn" class="close-x">&times;</button>
      
      <div class="popup-left">
        <div class="popup-badge">FREE GIFT</div>
        <img src="https://images.unsplash.com/photo-1544816155-12df9643f363?auto=format&fit=crop&q=80&w=800" alt="Custom ID Tag">
      </div>

      <div class="popup-right">
        <h2>Unlock Your Personalized Gift</h2>
        <p class="reward-intro">
            Get a <b>custom embroidered personal ID</b>—exclusively for early supporters.
        </p>
        
        <ul class="step-list">
            <li class="step-item">
                <div class="step-num">1</div>
                <div>Share this page on social media or with a friend.</div>
            </li>
            <li class="step-item">
                <div class="step-num">2</div>
                <div>Send a screenshot to <b>hello@manettabag.com</b>.</div>
            </li>
            <li class="step-item">
                <div class="step-num">3</div>
                <div>We’ll automatically add the custom embroidered ID to your order.</div>
            </li>
        </ul>

        <div class="action-group">
            <a href="https://www.facebook.com/sharer/sharer.php?u=manettabag.com" target="_blank" class="btn-share">
              <svg viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.15 5.96C15.21 5.96 16.12 6.04 16.39 6.08V8.7H14.86C13.65 8.7 13.41 9.27 13.41 10.1V12.06H16.32L15.86 14.96H13.41V21.96C18.19 21.21 21.86 17.06 21.86 12.06C21.86 6.53 17.36 2.04 12 2.04Z"/></svg>
              <span>Facebook</span>
            </a>
            
            <a href="https://twitter.com/intent/tweet?text=Check%20out%20Manetta%20Bag&url=manettabag.com" target="_blank" class="btn-share">
              <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              <span>Twitter</span>
            </a>
            
            <a href="https://www.instagram.com/" target="_blank" class="btn-share">
              <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
              <span>Instagram</span>
            </a>

            <button id="btn-copy-link" class="btn-share" type="button">
              <svg viewBox="0 0 24 24"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/></svg>
              <span id="copy-text">Copy Link</span>
            </button>
        </div>
        
        <div class="popup-footer">
            It only takes a moment, and it helps us reach more creators like you.
        </div>
      </div>
    </div>
  </div>

</section>

<script is:inline>
  (function () {
    const form = document.querySelector("#hero-form");
    const popup = document.querySelector("#sharePopup");
    const closeBtn = document.querySelector("#popupCloseBtn");
    const copyBtn = document.querySelector("#btn-copy-link"); // 获取 Copy 按钮
    
    let submittedEmail = "";

    // 跳转逻辑
    const proceedToNextPage = () => {
        window.location.href = "/reservation?email=" + encodeURIComponent(submittedEmail);
    };

    if (closeBtn) closeBtn.addEventListener("click", proceedToNextPage);
    if (popup) {
        popup.addEventListener("click", (e) => {
            if (e.target === popup) proceedToNextPage();
        });
    }

    // ✅ 新增：Copy Link 逻辑
    if (copyBtn) {
        copyBtn.addEventListener("click", () => {
            const currentUrl = window.location.href;
            
            // 使用 Clipboard API
            navigator.clipboard.writeText(currentUrl).then(() => {
                const originalHtml = copyBtn.innerHTML; // 保存原始图标和文字
                
                // 变成 ✅ 图标和 Copied 文字
                copyBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" style="fill:#22c55e;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    <span style="color:#22c55e;">Copied!</span>
                `;
                copyBtn.style.borderColor = "#22c55e"; // 边框变绿

                // 2秒后恢复原状
                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                    copyBtn.style.borderColor = "#ddd";
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert("Please manually copy the URL from your browser address bar.");
            });
        });
    }

    // 表单提交逻辑
    if (!form) return;
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const input = form.querySelector("#hero-email");
      const email = (input?.value || "").trim();
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!emailPattern.test(email)) {
        alert("Please enter a valid email address.");
        input && input.focus();
        return;
      }

      try {
        localStorage.setItem("manetta_email", email);
      } catch (e) {}

      try {
        const res = await fetch("/api/klaviyo-subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          alert(data.error || "Subscription failed, please try again.");
          return;
        }

        if (typeof fbq === 'function') {
          fbq('track', 'Lead', { content_name: 'Hero Banner Email Subscribe', source: 'HomePageHero' });
        }
        
        submittedEmail = email;
        if (popup) popup.style.display = "block";
        else proceedToNextPage();

      } catch (err) {
        console.error(err);
        alert("Network error, please try again.");
      }
    });
  })();
</script>