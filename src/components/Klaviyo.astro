---
interface Props {
  /** Klaviyo 核心脚本使用的公共 API Key (Site ID)。 */
  klaviyoApiKey: string;

  /** 电脑端表单的 Form ID（例如：RxcZeJ）。 */
  desktopFormId: string;

  /** 手机端表单的 Form ID（可以和上面一样）。 */
  mobileFormId: string;
}

const { klaviyoApiKey, desktopFormId, mobileFormId } = Astro.props;
---

<section class="klaviyo-form-module">
  <div class="klaviyo-form-inner">

    {/* 桌面端表单，占位容器 */}
    <div class="klaviyo-placeholder-wrapper desktop-form-wrapper">
      <div
        class={`klaviyo-form-${desktopFormId}`}
        data-klaviyo-form={desktopFormId}
      ></div>
    </div>

    {/* 手机端表单，占位容器 */}
    <div class="klaviyo-placeholder-wrapper mobile-form-wrapper">
      <div
        class={`klaviyo-form-${mobileFormId}`}
        data-klaviyo-form={mobileFormId}
      ></div>
    </div>

  </div>
</section>

{klaviyoApiKey && (
  <>
    {/* 1）Klaviyo 官方核心脚本 */}
    <script
      type="text/javascript"
      src={`https://static.klaviyo.com/onsite/js/klaviyo.js?company_id=${klaviyoApiKey}`}
      async
    ></script>

    {/* 2）监听 Klaviyo 表单提交事件，把 email/first_name 写入 localStorage */}
    <script is:inline>
      // 用一个 IIFE 防止变量污染
      (function () {
        function pickEmailFrom(obj) {
          if (!obj) return '';

          var candidates = [
            obj.$email,
            obj.email,
            obj.Email,
            obj['email'],
            obj['$email'],
            obj['Email'],
          ];

          for (var i = 0; i < candidates.length; i++) {
            var v = candidates[i];
            if (
              typeof v === 'string' &&
              v.indexOf('@') !== -1 &&         // 要有 @
              v.indexOf('{{') === -1 &&       // 不能包含 {{ 占位符
              v.indexOf('}}') === -1
            ) {
              return v;
            }
          }
          return '';
        }

        window.addEventListener('klaviyoForms', function (e) {
          try {
            if (!e || !e.detail) return;

            // 打印整个 detail 看真实结构（方便你在 Console 里检查）
            console.log('[Klaviyo] klaviyoForms event detail:', e.detail);

            // 只处理典型的成功事件类型
            var type = e.detail.type;
            if (
              type !== 'submit' &&
              type !== 'success' &&
              type !== 'formSubmitted'
            ) {
              return;
            }

            var meta = e.detail.meta || e.detail.data || {};
            var fields = meta.fields || meta;
            var profile = e.detail.profile || meta.profile || {};

            // 先从 meta / fields / profile 中“挑”一个真正的邮箱
            var email =
              pickEmailFrom(meta) ||
              pickEmailFrom(fields) ||
              pickEmailFrom(profile);

            if (!email && profile && typeof profile.email === 'string') {
              // 再兜底一次
              var v = profile.email;
              if (v.indexOf('@') !== -1 && v.indexOf('{{') === -1) {
                email = v;
              }
            }

            if (email) {
              console.log('[Klaviyo] final captured email:', email);
              localStorage.setItem('manetta_email', email);
            } else {
              console.warn(
                '[Klaviyo] no valid email found, meta/fields/profile =',
                meta,
                fields,
                profile
              );
            }

            // 可选：first_name 逻辑，如果你以后要用可以保留
            var firstName =
              fields.first_name ||
              fields.firstName ||
              fields.$first_name ||
              profile.first_name ||
              profile.firstName ||
              '';

            if (firstName) {
              console.log('[Klaviyo] captured first name:', firstName);
              localStorage.setItem('manetta_name', firstName);
            }
          } catch (err) {
            console.warn('Klaviyo form listener error:', err);
          }
        });
      })();
    </script>
  </>
)}



<style>
/* ------------------------------------- */
/* 1. 模块容器基础样式 (全宽无边距) */
/* ------------------------------------- */
.klaviyo-form-module {
  /* 全宽 hack */
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
  z-index: 1;
  padding: 0;
}

.klaviyo-form-inner {
  width: 100%;
  max-width: none;
  margin: 0;
  padding: 0;
}

/* 占位符容器的样式 */
.klaviyo-placeholder-wrapper {
  width: 100%;
  text-align: center;
}

/* 默认（电脑端 >= 769px）: 隐藏手机端表单 */
.mobile-form-wrapper {
  display: none;
}

/* 手机端样式 (<= 768px) */
@media (max-width: 768px) {
  .desktop-form-wrapper {
    display: none;
  }

  .mobile-form-wrapper {
    display: block;
  }
}

/* 确保 Klaviyo 注入的内容适应全宽 */
.klaviyo-placeholder-wrapper :global(iframe),
.klaviyo-placeholder-wrapper :global(div) {
  max-width: 100% !important;
  box-sizing: border-box;
}
</style>
